# MultiExchangeChart ç»„ä»¶æ¶æ„æ–‡æ¡£

## ğŸ“ æ–‡ä»¶ç»“æ„

é‡æ„åçš„ä»£ç æŒ‰åŠŸèƒ½æ¨¡å—æ¸…æ™°åˆ†ç±»ï¼Œä¾¿äºé˜…è¯»å’Œç»´æŠ¤ï¼š

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MultiExchangeChart.jsx                  # åŸå§‹ç‰ˆæœ¬
â”‚   â””â”€â”€ MultiExchangeChart.refactored.jsx       # é‡æ„ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
â”‚
â”œâ”€â”€ hooks/                                       # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useExchangeData.js                      # ã€æ•°æ®è·å–ã€‘
â”‚   â”œâ”€â”€ useChartManager.js                      # ã€å›¾è¡¨ç®¡ç†ã€‘
â”‚   â”œâ”€â”€ usePriceMarkers.js                      # ã€å·®å¼‚æ ‡æ³¨ã€‘
â”‚   â””â”€â”€ useExchangeManager.js                   # ã€äº¤æ˜“æ‰€ç®¡ç†ã€‘
â”‚
â””â”€â”€ utils/
    â””â”€â”€ chartUtils.js                           # ã€å·¥å…·å‡½æ•°ã€‘
```

---

## ğŸ”§ åŠŸèƒ½æ¨¡å—è¯¦è§£

### 1ï¸âƒ£ **å·¥å…·å‡½æ•°æ¨¡å—** (`utils/chartUtils.js`)

**èŒè´£**ï¼šæä¾›çº¯å‡½æ•°å·¥å…·ï¼Œä¸æ¶‰åŠçŠ¶æ€ç®¡ç†

**åŒ…å«åŠŸèƒ½**ï¼š
- âœ… `convertDataToChartFormat()` - æ•°æ®æ ¼å¼è½¬æ¢
- âœ… `getExchangeKey()` - ç”Ÿæˆäº¤æ˜“æ‰€å”¯ä¸€æ ‡è¯†
- âœ… `getTimeRange()` - è®¡ç®—æ—¶é—´èŒƒå›´
- âœ… `createChartConfig()` - åˆ›å»ºå›¾è¡¨é…ç½®å¯¹è±¡
- âœ… `createLineSeriesConfig()` - åˆ›å»ºçº¿æ¡é…ç½®

**ç‰¹ç‚¹**ï¼š
- æ— å‰¯ä½œç”¨
- å¯ç‹¬ç«‹æµ‹è¯•
- å¯å¤ç”¨äºå…¶ä»–ç»„ä»¶

---

### 2ï¸âƒ£ **æ•°æ®è·å– Hook** (`hooks/useExchangeData.js`)

**èŒè´£**ï¼šå°è£…æ‰€æœ‰ä¸åç«¯ API äº¤äº’çš„é€»è¾‘

**æä¾›çš„çŠ¶æ€**ï¼š
- `loading` - åŠ è½½çŠ¶æ€
- `error` - é”™è¯¯ä¿¡æ¯
- `chartData` - å›¾è¡¨æ•°æ® (Map ç»“æ„)

**æä¾›çš„æ–¹æ³•**ï¼š
- `fetchAllData(exchanges, interval, limit)` - è·å–æ‰€æœ‰äº¤æ˜“æ‰€æ•°æ®
- `fetchNewData(newConfigs, interval, limit)` - å¢é‡è·å–æ–°å¢äº¤æ˜“æ‰€æ•°æ®
- `clearError()` - æ¸…é™¤é”™è¯¯ä¿¡æ¯
- `removeData(key)` - åˆ é™¤æŒ‡å®šäº¤æ˜“æ‰€æ•°æ®

**å†…éƒ¨å‡½æ•°**ï¼š
- `fetchExchangeData()` - è·å–å•ä¸ªäº¤æ˜“æ‰€æ•°æ®ï¼ˆç§æœ‰ï¼‰

**ç‰¹ç‚¹**ï¼š
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- æ”¯æŒå¹¶è¡Œè¯·æ±‚
- æ”¯æŒéƒ¨åˆ†å¤±è´¥å®¹é”™

---

### 3ï¸âƒ£ **å›¾è¡¨ç®¡ç† Hook** (`hooks/useChartManager.js`)

**èŒè´£**ï¼šç®¡ç†å›¾è¡¨å®ä¾‹å’Œçº¿æ¡ç³»åˆ—

**æä¾›çš„æ–¹æ³•**ï¼š
- `addLineSeries(config)` - æ·»åŠ çº¿æ¡ç³»åˆ—
- `removeLineSeries(config)` - åˆ é™¤çº¿æ¡ç³»åˆ—
- `updateSeriesData(exchanges, chartData)` - æ›´æ–°çº¿æ¡æ•°æ®
- `getLineSeries(config)` - è·å–æŒ‡å®šçº¿æ¡ç³»åˆ—
- `clearAllMarkers(exchanges)` - æ¸…ç©ºæ‰€æœ‰æ ‡è®°

**å†…éƒ¨ç®¡ç†**ï¼š
- `chartRef` - å›¾è¡¨å®ä¾‹å¼•ç”¨
- `lineSeriesMapRef` - çº¿æ¡ç³»åˆ—æ˜ å°„è¡¨
- çª—å£å¤§å°è‡ªåŠ¨è°ƒæ•´
- æ—¶é—´è½´è‡ªåŠ¨ç¼©æ”¾

**ç‰¹ç‚¹**ï¼š
- å°è£… lightweight-charts API
- è‡ªåŠ¨å¤„ç†å›¾è¡¨ç”Ÿå‘½å‘¨æœŸ
- å“åº”å¼è®¾è®¡

---

### 4ï¸âƒ£ **å·®å¼‚æ ‡æ³¨ Hook** (`hooks/usePriceMarkers.js`)

**èŒè´£**ï¼šè®¡ç®—å’Œæ˜¾ç¤ºäº¤æ˜“æ‰€é—´çš„ä»·æ ¼å·®å¼‚

**å‚æ•°**ï¼š
- `enableMarkers` - æ˜¯å¦å¯ç”¨æ ‡æ³¨
- `threshold` - å·®å¼‚é˜ˆå€¼
- `exchanges` - äº¤æ˜“æ‰€åˆ—è¡¨
- `chartData` - å›¾è¡¨æ•°æ®
- `getLineSeries` - è·å–çº¿æ¡æ–¹æ³•
- `clearAllMarkers` - æ¸…ç©ºæ ‡è®°æ–¹æ³•

**æ ¸å¿ƒå‡½æ•°**ï¼š
- `calculatePriceMarkers()` - è®¡ç®—æ ‡è®°æ•°ç»„
- `calculateMaxDifference()` - è®¡ç®—æœ€å¤§å·®å¼‚
- `createMarker()` - åˆ›å»ºæ ‡è®°å¯¹è±¡

**ç‰¹ç‚¹**ï¼š
- ç®—æ³•ä¸ UI åˆ†ç¦»
- å¯é…ç½®é˜ˆå€¼
- è‡ªåŠ¨æ¸…ç†æ ‡è®°

---

### 5ï¸âƒ£ **äº¤æ˜“æ‰€ç®¡ç† Hook** (`hooks/useExchangeManager.js`)

**èŒè´£**ï¼šæ™ºèƒ½å¤„ç†äº¤æ˜“æ‰€çš„å¢åˆ æ”¹æ“ä½œ

**æ ¸å¿ƒé€»è¾‘**ï¼š
- æ£€æµ‹æ–°å¢çš„äº¤æ˜“æ‰€ â†’ æ·»åŠ çº¿æ¡ + è·å–æ•°æ®
- æ£€æµ‹åˆ é™¤çš„äº¤æ˜“æ‰€ â†’ åˆ é™¤çº¿æ¡ + æ¸…é™¤æ•°æ®
- åˆå§‹åŒ–åŠ è½½ â†’ å…¨é‡è·å–æ•°æ®

**ä¾èµ–çš„æ–¹æ³•**ï¼š
- `addLineSeries` - æ·»åŠ çº¿æ¡
- `removeLineSeries` - åˆ é™¤çº¿æ¡
- `fetchNewData` - å¢é‡æ•°æ®è·å–
- `fetchAllData` - å…¨é‡æ•°æ®è·å–
- `removeData` - åˆ é™¤æ•°æ®

**ç‰¹ç‚¹**ï¼š
- å¢é‡æ›´æ–°ä¼˜åŒ–
- é¿å…é‡å¤è¯·æ±‚
- è‡ªåŠ¨åŒæ­¥çŠ¶æ€

---

### 6ï¸âƒ£ **ä¸»ç»„ä»¶** (`MultiExchangeChart.refactored.jsx`)

**èŒè´£**ï¼šç»„åˆæ‰€æœ‰ Hooksï¼Œè´Ÿè´£ UI æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’

**ä»£ç ç»“æ„**ï¼š
```javascript
export default function MultiExchangeChart({ exchanges, height }) {
  // ========== çŠ¶æ€ç®¡ç† ==========
  const [interval, setInterval] = useState("15m");
  const [limit, setLimit] = useState(100);
  const [enableMarkers, setEnableMarkers] = useState(true);
  const [threshold, setThreshold] = useState(50);

  // ========== æ•°æ®è·å– ==========
  const { loading, error, chartData, ... } = useExchangeData();

  // ========== å›¾è¡¨ç®¡ç† ==========
  const { addLineSeries, updateSeriesData, ... } = useChartManager(...);

  // ========== äº¤æ˜“æ‰€ç®¡ç† ==========
  useExchangeManager(...);

  // ========== å·®å¼‚æ ‡æ³¨ ==========
  usePriceMarkers(...);

  // ========== UI æ¸²æŸ“ ==========
  return (
    <div>
      {/* æ§åˆ¶é¢æ¿ */}
      <Card>...</Card>
      
      {/* å›¾è¡¨åŒºåŸŸ */}
      <div ref={chartContainerRef}>...</div>
    </div>
  );
}
```

**ç‰¹ç‚¹**ï¼š
- ä»£ç å‡å°‘ 60%ï¼ˆä» 582 è¡Œ â†’ 240 è¡Œï¼‰
- èŒè´£å•ä¸€ï¼Œåªå…³æ³¨ UI
- æ˜“äºé˜…è¯»å’Œç»´æŠ¤

---

## ğŸ”„ æ•°æ®æµå›¾

```
ç”¨æˆ·æ“ä½œ
   â†“
ä¸»ç»„ä»¶çŠ¶æ€å˜åŒ– (interval, limit, exchanges)
   â†“
è§¦å‘ Hooks
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useExchangeManager                     â”‚
â”‚  - æ£€æµ‹æ–°å¢/åˆ é™¤äº¤æ˜“æ‰€                   â”‚
â”‚  - è°ƒç”¨ fetchNewData / removeLineSeries  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useExchangeData                        â”‚
â”‚  - å‘èµ· API è¯·æ±‚                        â”‚
â”‚  - æ›´æ–° chartData                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  useChartManager                        â”‚
â”‚  - æ›´æ–°çº¿æ¡æ•°æ® (updateSeriesData)       â”‚
â”‚  - è‡ªåŠ¨è°ƒæ•´æ—¶é—´è½´                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  usePriceMarkers                        â”‚
â”‚  - è®¡ç®—ä»·æ ¼å·®å¼‚                         â”‚
â”‚  - æ·»åŠ æ ‡è®°åˆ°å›¾è¡¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
UI æ›´æ–°
```

---

## ğŸ“Š ä»£ç å¯¹æ¯”

### åŸç‰ˆ vs é‡æ„ç‰ˆ

| æŒ‡æ ‡ | åŸç‰ˆ | é‡æ„ç‰ˆ |
|------|------|--------|
| ä¸»ç»„ä»¶è¡Œæ•° | 582 | 240 |
| æ–‡ä»¶æ•°é‡ | 1 | 6 |
| å‡½æ•°è€¦åˆåº¦ | é«˜ | ä½ |
| å¯æµ‹è¯•æ€§ | éš¾ | æ˜“ |
| å¯å¤ç”¨æ€§ | ä½ | é«˜ |
| å¯ç»´æŠ¤æ€§ | ä¸­ | é«˜ |

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ä½•æ—¶ä½¿ç”¨åŸç‰ˆï¼Ÿ
- å¿«é€ŸåŸå‹å¼€å‘
- å•æ–‡ä»¶ç®€å•åœºæ™¯
- ä¸éœ€è¦æ‰©å±•åŠŸèƒ½

### ä½•æ—¶ä½¿ç”¨é‡æ„ç‰ˆï¼Ÿ
- âœ… ç”Ÿäº§ç¯å¢ƒ
- âœ… éœ€è¦å•å…ƒæµ‹è¯•
- âœ… å›¢é˜Ÿåä½œå¼€å‘
- âœ… åŠŸèƒ½æŒç»­è¿­ä»£
- âœ… éœ€è¦å¤ç”¨éƒ¨åˆ†åŠŸèƒ½

---

## ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹

é‡æ„åçš„ä»£ç æ›´æ˜“äºæµ‹è¯•ï¼š

```javascript
// æµ‹è¯•å·¥å…·å‡½æ•°
import { convertDataToChartFormat } from '../utils/chartUtils';

test('convertDataToChartFormat æ­£ç¡®è½¬æ¢æ•°æ®', () => {
  const input = [{ time: 1234567890000, value: '100.5' }];
  const output = convertDataToChartFormat(input);
  expect(output[0].time).toBe(1234567890);
  expect(output[0].value).toBe(100.5);
});

// æµ‹è¯• Hook
import { renderHook } from '@testing-library/react-hooks';
import { useExchangeData } from '../hooks/useExchangeData';

test('fetchAllData æ­£ç¡®è·å–æ•°æ®', async () => {
  const { result } = renderHook(() => useExchangeData());
  await act(async () => {
    await result.current.fetchAllData([...], '15m', 100);
  });
  expect(result.current.chartData.size).toBeGreaterThan(0);
});
```

---

## ğŸš€ è¿ç§»æŒ‡å—

å¦‚æœä½ æƒ³ä»åŸç‰ˆè¿ç§»åˆ°é‡æ„ç‰ˆï¼š

1. **å¤åˆ¶æ–°æ–‡ä»¶**
   ```bash
   # ä¿ç•™åŸç‰ˆï¼ˆå¤‡ä»½ï¼‰
   mv MultiExchangeChart.jsx MultiExchangeChart.old.jsx
   
   # ä½¿ç”¨é‡æ„ç‰ˆ
   mv MultiExchangeChart.refactored.jsx MultiExchangeChart.jsx
   ```

2. **æ›´æ–°å¯¼å…¥**
   - å…¶ä»–æ–‡ä»¶çš„å¯¼å…¥è·¯å¾„æ— éœ€ä¿®æ”¹
   - API ä¿æŒ 100% å…¼å®¹

3. **æµ‹è¯•éªŒè¯**
   - æ‰€æœ‰åŠŸèƒ½åº”ä¸åŸç‰ˆå®Œå…¨ä¸€è‡´
   - æ€§èƒ½åº”ç›¸åŒæˆ–æ›´å¥½

---

## ğŸ“ æ‰©å±•å»ºè®®

åŸºäºæ–°æ¶æ„ï¼Œæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ ï¼š

- ğŸ”” å®æ—¶ WebSocket æ•°æ®æ¨é€ï¼ˆåªéœ€ä¿®æ”¹ `useExchangeData`ï¼‰
- ğŸ’¾ æœ¬åœ°ç¼“å­˜ä¼˜åŒ–ï¼ˆæ·»åŠ æ–° Hook `useDataCache`ï¼‰
- ğŸ“Š æ›´å¤šå›¾è¡¨ç±»å‹ï¼ˆæ‰©å±• `useChartManager`ï¼‰
- ğŸ¨ è‡ªå®šä¹‰ä¸»é¢˜ï¼ˆæå– `chartConfig` åˆ°é…ç½®æ–‡ä»¶ï¼‰
- ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡å åŠ ï¼ˆæ·»åŠ æ–° Hook `useIndicators`ï¼‰

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

ä¿®æ”¹ä»£ç æ—¶è¯·éµå¾ªæ¨¡å—åˆ’åˆ†ï¼š

- **å·¥å…·å‡½æ•°**ï¼šæ·»åŠ åˆ° `chartUtils.js`
- **API ç›¸å…³**ï¼šä¿®æ”¹ `useExchangeData.js`
- **å›¾è¡¨æ“ä½œ**ï¼šä¿®æ”¹ `useChartManager.js`
- **æ ‡æ³¨ç®—æ³•**ï¼šä¿®æ”¹ `usePriceMarkers.js`
- **UI å˜æ›´**ï¼šä¿®æ”¹ä¸»ç»„ä»¶

ä¿æŒæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ï¼




