# ç°è´§åˆçº¦æ•°æ®éš”ç¦»è¯´æ˜

## âŒ é—®é¢˜ï¼šç°è´§å’Œåˆçº¦æ•°æ®æ··åœ¨ä¸€èµ·

### é—®é¢˜è¡¨ç°
- æŸ¥è¯¢ç°è´§ä½™é¢æ—¶ï¼Œè¿”å›äº†åˆçº¦æŒä»“
- æŸ¥è¯¢åˆçº¦æŒä»“æ—¶ï¼Œè¿”å›äº†ç°è´§ä½™é¢
- WebSocket è®¢é˜…åˆçº¦ä»·æ ¼ï¼Œæ”¶åˆ°çš„å´æ˜¯ç°è´§ä»·æ ¼

### æ ¹æœ¬åŸå› 
**CCXT éœ€è¦é€šè¿‡ `defaultType` æ¥åŒºåˆ†æŸ¥è¯¢å“ªä¸ªå¸‚åœº**ï¼Œä½†ä¹‹å‰çš„å®ç°æ²¡æœ‰æ­£ç¡®è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šå•å®ä¾‹æ¶æ„ + defaultType éš”ç¦»

### æ ¸å¿ƒæ€æƒ³
**æ¯ä¸ªé€‚é…å™¨å®ä¾‹åªè´Ÿè´£ä¸€ä¸ªå¸‚åœºç±»å‹**ï¼Œåœ¨åˆå§‹åŒ–æ—¶å°±ç¡®å®šå¥½ `defaultType`ã€‚

### 1ï¸âƒ£ é€‚é…å™¨å®ä¾‹åŒ–æ—¶è®¾ç½® defaultType

#### **Binance é€‚é…å™¨** (`backend/exchange_adapters/binance_adapter.py`)
```python
def _initialize_exchange(self):
    config = {
        'apiKey': self.config.get('apiKey', ''),
        'secret': self.config.get('secret', ''),
        'enableRateLimit': True,
        'options': {
            # æ ¹æ® market_type è®¾ç½®
            'defaultType': 'future' if self.market_type == 'futures' else 'spot'
        }
    }
    self.exchange = ccxt.binance(config)
```

**å…³é”®ï¼šBinance åˆçº¦ç”¨ `'future'`ï¼Œä¸æ˜¯ `'swap'`ï¼**

#### **Gate.io é€‚é…å™¨** (`backend/exchange_adapters/gate_adapter.py`)
```python
def _initialize_exchange(self):
    base_config = {
        'apiKey': self.config.get('apiKey', ''),
        'secret': self.config.get('secret', ''),
        'enableRateLimit': True,
    }
    
    # æ ¹æ® market_type è®¾ç½® defaultType
    if self.market_type == 'futures':
        base_config['options'] = {'defaultType': 'swap'}  # Gate åˆçº¦ç”¨ 'swap'
    else:
        base_config['options'] = {'defaultType': 'spot'}
    
    self.exchange = ccxt.gate(base_config)
```

#### **é»˜è®¤é€‚é…å™¨** (`backend/exchange_adapters/default_adapter.py`)
```python
def _initialize_exchange(self):
    exchange_config = {
        'apiKey': self.config.get('apiKey', ''),
        'secret': self.config.get('secret', ''),
        'enableRateLimit': True,
    }
    
    # æ ¹æ® market_type è®¾ç½® defaultType
    if self.market_type == 'futures':
        # å¸å®‰ä½¿ç”¨ 'future'ï¼Œå…¶ä»–äº¤æ˜“æ‰€ï¼ˆå¦‚ OKXã€Gateï¼‰ä½¿ç”¨ 'swap'
        default_type = 'future' if self.exchange_id == 'binance' else 'swap'
        exchange_config['options'] = {'defaultType': default_type}
    elif self.market_type == 'spot':
        exchange_config['options'] = {'defaultType': 'spot'}
    
    self.exchange = exchange_class(exchange_config)
```

### 2ï¸âƒ£ åŸºç¡€é€‚é…å™¨æ ¹æ® market_type è°ƒç”¨ä¸åŒæ–¹æ³•

#### **ä½™é¢/æŒä»“æŸ¥è¯¢** (`backend/exchange_adapters/base.py`)
```python
def fetch_positions(self) -> List[Dict]:
    """è·å–æŒä»“/ä½™é¢ï¼ˆå•å®ä¾‹æ¶æ„ï¼‰"""
    try:
        if self.market_type == 'spot':
            # ç°è´§ï¼šè°ƒç”¨ fetch_balance()
            balance_data = self.exchange.fetch_balance()
            return self._normalize_spot_balance(balance_data)
        else:  # futures
            # åˆçº¦ï¼šè°ƒç”¨ fetch_positions()
            positions_data = self.exchange.fetch_positions()
            return self._normalize_futures_positions(positions_data)
```

**ä¸ºä»€ä¹ˆè¿™æ ·èƒ½åŒºåˆ†ï¼Ÿ**
- å› ä¸º `self.exchange` å·²ç»è®¾ç½®äº† `defaultType`
- CCXT ä¼šæ ¹æ® `defaultType` è°ƒç”¨å¯¹åº”çš„ API ç«¯ç‚¹ï¼š
  - `defaultType='spot'` â†’ è°ƒç”¨ç°è´§ API
  - `defaultType='swap'/'future'` â†’ è°ƒç”¨åˆçº¦ API

### 3ï¸âƒ£ WebSocket ç®¡ç†å™¨ä¹Ÿè¦è®¾ç½® defaultType

#### **WebSocket å®ä¾‹åˆ›å»º** (`backend/util/websocket_util.py`)
```python
async def get_pro_exchange(self, exchange_name: str, market_type: str = 'spot') -> ccxtpro.Exchange:
    """è·å–æˆ–åˆ›å»º ccxt.pro äº¤æ˜“æ‰€å®ä¾‹ï¼ˆç”¨äº WebSocketï¼‰"""
    
    # ä½¿ç”¨åŒ…å«å¸‚åœºç±»å‹çš„keyæ¥åŒºåˆ†ä¸åŒçš„å®ä¾‹
    exchange_key = f"{exchange_name}_{market_type}"
    
    if exchange_key not in self.pro_exchanges:
        # æ ¹æ®äº¤æ˜“æ‰€å’Œå¸‚åœºç±»å‹è®¾ç½® defaultType
        if market_type.lower() in ['futures', 'future']:
            # å¸å®‰ä½¿ç”¨ 'future'ï¼Œå…¶ä»–äº¤æ˜“æ‰€ï¼ˆå¦‚ OKXã€Gateï¼‰ä½¿ç”¨ 'swap'
            if exchange_name.lower() == 'binance':
                default_type = 'future'
            else:
                default_type = 'swap'
        else:
            default_type = 'spot'
        
        # åˆ›å»ºé…ç½®
        config = {
            'enableRateLimit': True,
            'timeout': 30000,
            'options': {
                'defaultType': default_type,  # â† å…³é”®è®¾ç½®
            }
        }
        
        # åˆ›å»ºäº¤æ˜“æ‰€å®ä¾‹
        exchange = exchange_class(config)
        self.pro_exchanges[exchange_key] = exchange
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `exchange_key = f"{exchange_name}_{market_type}"` åŒºåˆ†ä¸åŒå¸‚åœºçš„å®ä¾‹
- æ¯ä¸ªå¸‚åœºç±»å‹åˆ›å»ºç‹¬ç«‹çš„ WebSocket å®ä¾‹

---

## ğŸ“Š äº¤æ˜“æ‰€ defaultType å‚è€ƒè¡¨

| äº¤æ˜“æ‰€ | ç°è´§ | åˆçº¦ | å¤‡æ³¨ |
|--------|------|------|------|
| **Binance** | `spot` | `future` | âš ï¸ ç‰¹æ®Šï¼šåŒ…æ‹¬æ°¸ç»­å’Œäº¤å‰² |
| **OKX** | `spot` | `swap` | æ°¸ç»­åˆçº¦ |
| **Gate.io** | `spot` | `swap` | æ°¸ç»­åˆçº¦ |
| **Bybit** | `spot` | `linear` | çº¿æ€§åˆçº¦ |
| **å…¶ä»–äº¤æ˜“æ‰€** | `spot` | `swap` | å¤§å¤šæ•°ç”¨ swap |

---

## ğŸ”„ ä½¿ç”¨ç¤ºä¾‹

### REST API æŸ¥è¯¢
```python
from exchange_adapters.adapter_factory import get_adapter

# åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„é€‚é…å™¨å®ä¾‹
spot_adapter = get_adapter('gate', 'spot', config)
futures_adapter = get_adapter('gate', 'futures', config)

# æŸ¥è¯¢ç°è´§ä½™é¢ï¼ˆåªè¿”å›ç°è´§æ•°æ®ï¼‰
spot_balance = spot_adapter.fetch_positions()
# è¿”å›: [{'currency': 'USDT', 'free': 1000, 'used': 0, ...}, ...]

# æŸ¥è¯¢åˆçº¦æŒä»“ï¼ˆåªè¿”å›åˆçº¦æ•°æ®ï¼‰
futures_positions = futures_adapter.fetch_positions()
# è¿”å›: [{'symbol': 'BTC/USDT:USDT', 'contracts': 0.5, 'unrealizedPnl': 10, ...}, ...]
```

### WebSocket è®¢é˜…
```python
# WebSocket ç®¡ç†å™¨ä¼šè‡ªåŠ¨åˆ›å»ºç‹¬ç«‹çš„å®ä¾‹
ws_manager = WebSocketManager(proxy_config, market_cache)

# è®¢é˜…ç°è´§ä»·æ ¼ï¼ˆä½¿ç”¨ spot å®ä¾‹ï¼‰
await ws_manager.get_pro_exchange('binance', 'spot')

# è®¢é˜…åˆçº¦ä»·æ ¼ï¼ˆä½¿ç”¨ future å®ä¾‹ï¼‰
await ws_manager.get_pro_exchange('binance', 'futures')
```

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] **Binance é€‚é…å™¨**ï¼šåˆçº¦ç”¨ `'future'`
- [x] **Gate é€‚é…å™¨**ï¼šåˆçº¦ç”¨ `'swap'`
- [x] **Default é€‚é…å™¨**ï¼šæ ¹æ®äº¤æ˜“æ‰€åŒºåˆ† `'future'` æˆ– `'swap'`
- [x] **Base é€‚é…å™¨**ï¼šæ ¹æ® `market_type` è°ƒç”¨ä¸åŒæ–¹æ³•
- [x] **WebSocket ç®¡ç†å™¨**ï¼šåˆ›å»ºç‹¬ç«‹çš„ pro å®ä¾‹
- [x] **æµ‹è¯•éªŒè¯**ï¼š
  - ç°è´§ä½™é¢ â‰  åˆçº¦æŒä»“
  - WebSocket ç°è´§ä»·æ ¼ â‰  åˆçº¦ä»·æ ¼

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- [CCXT å®˜æ–¹æ–‡æ¡£ - defaultType](https://docs.ccxt.com/#/?id=default-market-type)
- [Binance API æ–‡æ¡£](https://binance-docs.github.io/apidocs/)
- [Gate.io API æ–‡æ¡£](https://www.gate.io/docs/developers/)
- [é€‚é…å™¨æ¨¡å¼è¯´æ˜](./WHY_ADAPTER_PATTERN.md)

